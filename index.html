<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>FlowStable • The Gateway</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.umd.min.js"></script>
  <style>
    /* --- FLOWSTABLE THEME --- */
    :root {
      --bg: #020617;
      --card-bg: rgba(15, 23, 42, 0.96);
      --border: rgba(31, 41, 55, 0.9);
      --accent: #3b82f6;
      --accent-hover: #2563eb;
      --text-main: #f9fafb;
      --text-muted: #9ca3af;
      --input-bg: #020617;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: system-ui, -apple-system, BlinkMacSystemFont, "Inter", sans-serif; }

    body {
      background: radial-gradient(circle at top, #0f172a 0, #000 60%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .container { width: 100%; max-width: 460px; }

    /* Header */
    .header { text-align: center; margin-bottom: 24px; }
    .logo { font-size: 2.2rem; font-weight: 800; letter-spacing: -0.03em; color: #fff; }
    .logo span { color: var(--accent); }
    .tagline { margin-top: 6px; font-size: 0.9rem; color: var(--text-muted); }

    /* Card */
    .card {
      background: var(--card-bg);
      border: 1px solid var(--border);
      border-radius: 24px;
      padding: 24px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
      position: relative;
      overflow: hidden;
    }

    /* Tabs */
    .tabs {
      display: flex;
      background: rgba(2, 6, 23, 0.6);
      padding: 5px;
      border-radius: 999px;
      margin-bottom: 24px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .tab-btn {
      flex: 1;
      background: transparent;
      border: none;
      padding: 10px;
      color: var(--text-muted);
      font-weight: 600;
      font-size: 0.9rem;
      border-radius: 999px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .tab-btn:hover { color: #fff; }
    .tab-btn.active {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
    }

    /* Input Area */
    .input-box {
      background: var(--input-bg);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 16px;
      padding: 16px;
      margin-bottom: 16px;
      transition: 0.2s;
    }
    .input-box:focus-within { border-color: var(--accent); }

    .label-row { display: flex; justify-content: space-between; font-size: 0.85rem; color: var(--text-muted); margin-bottom: 8px; }
    .input-row { display: flex; justify-content: space-between; align-items: center; }
    
    input {
      background: transparent;
      border: none;
      font-size: 1.8rem;
      color: #fff;
      width: 60%;
      outline: none;
      font-weight: 600;
    }
    input::placeholder { color: #334155; }

    .badge {
      background: #1e293b;
      padding: 6px 12px;
      border-radius: 999px;
      font-size: 0.9rem;
      font-weight: 600;
      color: #e2e8f0;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    /* Buttons */
    .btn {
      width: 100%;
      padding: 16px;
      border-radius: 16px;
      border: none;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .btn-main {
      background: var(--accent);
      color: #fff;
      box-shadow: 0 4px 15px rgba(59, 130, 246, 0.25);
      margin-top: 10px;
    }
    .btn-main:hover:not(:disabled) { background: var(--accent-hover); transform: translateY(-1px); }
    .btn-main:disabled { background: #1e293b; color: #475569; cursor: not-allowed; box-shadow: none; transform: none; }

    .btn-wallet {
      background: rgba(59, 130, 246, 0.1);
      color: var(--accent);
      margin-bottom: 12px;
      font-size: 0.9rem;
    }
    .btn-wallet:hover { background: rgba(59, 130, 246, 0.15); }

    .row-btns { display: flex; gap: 10px; margin-top: 10px; }
    .btn-sec {
      flex: 1;
      padding: 12px;
      background: rgba(255,255,255,0.03);
      border: 1px solid rgba(255,255,255,0.1);
      color: var(--accent);
      border-radius: 12px;
      cursor: pointer;
      font-weight: 600;
    }
    .btn-sec:hover:not(:disabled) { background: rgba(255,255,255,0.08); }
    .btn-sec:disabled { opacity: 0.5; cursor: not-allowed; }

    /* Utils */
    .hidden { display: none; }
    .status-bar {
      margin-top: 20px;
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-muted);
      background: rgba(0,0,0,0.2);
      padding: 8px;
      border-radius: 8px;
    }
    .network-pill { font-size: 0.75rem; padding: 4px 8px; border-radius: 6px; background: #1e293b; color: #94a3b8; display: inline-block; margin-top: 10px; }
  </style>
</head>
<body>

<div class="container">
  <div class="header">
    <div class="logo">Flow<span>Stable</span></div>
    <p class="tagline">The Gateway to StableChain</p>
  </div>

  <div class="card">
    <div class="tabs">
      <button class="tab-btn active" onclick="setTab('mint')">1. Mint</button>
      <button class="tab-btn" onclick="setTab('bridge')">2. Bridge</button>
      <button class="tab-btn" onclick="setTab('unwrap')">3. Unwrap</button>
    </div>

    <div id="tab-mint">
      <div class="input-box">
        <div class="label-row"><span>You receive</span> <span id="bal-mint">Bal: --</span></div>
        <div class="input-row">
          <input id="in-mint" type="text" value="1000" placeholder="0.0">
          <div class="badge">USDT0 <small style="opacity:0.5; margin-left:4px">(Sep)</small></div>
        </div>
      </div>
      <button id="btn-mint" class="btn btn-main" onclick="runMint()">Mint Tokens</button>
    </div>

    <div id="tab-bridge" class="hidden">
      <div class="input-box">
        <div class="label-row"><span>You bridge</span> <span id="bal-bridge">Bal: --</span></div>
        <div class="input-row">
          <input id="in-bridge" type="text" placeholder="0.0">
          <div class="badge">USDT0 <small style="opacity:0.5; margin-left:4px">(Sep)</small></div>
        </div>
      </div>
      <div class="row-btns">
        <button class="btn-sec" onclick="runApproveBridge()">1. Approve</button>
        <button class="btn-sec" onclick="runQuote()">2. Quote Fee</button>
      </div>
      <button id="btn-bridge" class="btn btn-main" onclick="runBridge()" disabled>3. Bridge Asset</button>
    </div>

    <div id="tab-unwrap" class="hidden">
      <div class="input-box">
        <div class="label-row"><span>You unwrap</span> <span id="bal-unwrap">Bal: --</span></div>
        <div class="input-row">
          <input id="in-unwrap" type="text" placeholder="0.0" value="100">
          <div class="badge">USDT0 <small style="opacity:0.5; margin-left:4px">(Stbl)</small></div>
        </div>
      </div>
      <div class="row-btns">
        <button class="btn-sec" onclick="runApproveUnwrap()">1. Approve</button>
      </div>
      <button id="btn-unwrap" class="btn btn-main" onclick="runSwap()" disabled>2. Swap to gUSDT</button>
    </div>

    <div style="margin-top: 20px;">
      <button id="btn-connect" class="btn btn-wallet" onclick="connect()">Connect Wallet</button>
      <div class="status-bar" id="status">Ready to start</div>
      <div style="text-align: center;"><span id="net-badge" class="network-pill">Not Connected</span></div>
    </div>
  </div>
</div>

<script>
/** * SINGLE FILE LOGIC CONTROLLER 
 * Optimized to prevent Rate Limits (429) & Auto-Switch Networks
 */

const CONF = {
  SEPOLIA: {
    idHex: "0xaa36a7", idDec: 11155111,
    rpc: "https://ethereum-sepolia-rpc.publicnode.com",
    token: "0xc4DCC311c028e341fd8602D8eB89c5de94625927",
    oapp: "0xc099cD946d5efCC35A99D64E808c1430cEf08126",
    lzOpt: "0x00030100110100000000000000000000000000030d40",
    eid: 40374
  },
  STABLE: {
    idHex: "0x899", idDec: 2201,
    rpc: "https://rpc.testnet.stable.xyz",
    token: "0x78Cf24370174180738C5B8E352B6D14c83a6c9A9",
    wrapper: "0xcAB8F3ed8528655E0C2fad1C504c6CfEccf50B90"
  }
};

const ABIS = {
  ERC20: [
    "function mint(address,uint256) public",
    "function balanceOf(address) view returns (uint256)",
    "function approve(address,uint256) returns (bool)",
    "function decimals() view returns (uint8)"
  ],
  OFT: [
    "function quoteSend((uint32,bytes32,uint256,uint256,bytes,bytes,bytes), bool) view returns (uint256, uint256)",
    "function send((uint32,bytes32,uint256,uint256,bytes,bytes,bytes),(uint256,uint256),address) payable"
  ],
  WRAPPER: ["function withdraw(uint256) public"]
};

let provider, signer, account;
let currTab = 'mint';
let cachedFee = null;

// -- UTILS --
const getEl = (id) => document.getElementById(id);
const log = (msg) => getEl('status').innerText = msg;
const pad = (addr) => "0x" + ethers.getAddress(addr).slice(2).padStart(64, "0");

// -- INIT --
async function connect() {
  if(!window.ethereum) return alert("No MetaMask");
  try {
    provider = new ethers.BrowserProvider(window.ethereum);
    const accs = await provider.send("eth_requestAccounts", []);
    account = accs[0];
    signer = await provider.getSigner();
    
    getEl('btn-connect').innerText = account.slice(0,6) + "..." + account.slice(-4);
    
    window.ethereum.on('chainChanged', () => window.location.reload());
    checkNet();
  } catch(e) { log("Connection Failed"); }
}

async function setTab(tab) {
  currTab = tab;
  // UI Switch
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  
  ['mint','bridge','unwrap'].forEach(t => getEl(`tab-${t}`).classList.add('hidden'));
  getEl(`tab-${tab}`).classList.remove('hidden');

  if(account) checkNet(); // Check network & fetch balance ONLY for active tab
}

async function checkNet() {
  const net = await provider.getNetwork();
  const cid = Number(net.chainId);
  
  let target = (currTab === 'unwrap') ? CONF.STABLE : CONF.SEPOLIA;
  let targetName = (currTab === 'unwrap') ? "Stable Testnet" : "Sepolia";

  if(cid !== target.idDec) {
    getEl('net-badge').innerText = "Wrong Network";
    getEl('net-badge').style.color = "#ff6b6b";
    log(`Switching to ${targetName}...`);
    try {
      await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: target.idHex }] });
    } catch(e) {
      if(e.code === 4902 && currTab === 'unwrap') {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [{
            chainId: target.idHex, chainName: "Stable Testnet",
            rpcUrls: [target.rpc], nativeCurrency: {name:"gUSDT", symbol:"gUSDT", decimals:18}
          }]
        });
      }
    }
  } else {
    getEl('net-badge').innerText = targetName;
    getEl('net-badge').style.color = "#4ade80";
    log("Connected & Ready");
    updateBal();
  }
}

// -- LAZY BALANCE CHECK --
async function updateBal() {
  try {
    // Only fetch for ACTIVE TAB
    if(currTab === 'mint') {
      const c = new ethers.Contract(CONF.SEPOLIA.token, ABIS.ERC20, provider);
      const b = await c.balanceOf(account);
      getEl('bal-mint').innerText = `Bal: ${ethers.formatUnits(b, 6)}`;
    }
    else if(currTab === 'bridge') {
      const c = new ethers.Contract(CONF.SEPOLIA.token, ABIS.ERC20, provider);
      const b = await c.balanceOf(account);
      getEl('bal-bridge').innerText = `Bal: ${ethers.formatUnits(b, 6)}`;
    }
    else if(currTab === 'unwrap') {
      const c = new ethers.Contract(CONF.STABLE.token, ABIS.ERC20, provider);
      const b = await c.balanceOf(account);
      // FIXED: 6 Decimals for USDT0
      getEl('bal-unwrap').innerText = `Bal: ${ethers.formatUnits(b, 6)}`;
    }
  } catch(e) { console.log("Bal Error", e); }
}

// -- LOGIC --

// 1. Mint
async function runMint() {
  try {
    const v = getEl('in-mint').value;
    const c = new ethers.Contract(CONF.SEPOLIA.token, ABIS.ERC20, signer);
    log("Minting...");
    const tx = await c.mint(account, ethers.parseUnits(v, 6));
    await tx.wait();
    log("Minted! ✅");
    updateBal();
  } catch(e) { log(e.reason||e.message); }
}

// 2. Bridge
async function runApproveBridge() {
  try {
    const v = getEl('in-bridge').value;
    const c = new ethers.Contract(CONF.SEPOLIA.token, ABIS.ERC20, signer);
    log("Approving...");
    await (await c.approve(CONF.SEPOLIA.oapp, ethers.parseUnits(v, 6))).wait();
    log("Approved ✅");
  } catch(e) { log(e.reason||e.message); }
}

async function runQuote() {
  try {
    const v = getEl('in-bridge').value;
    const amt = ethers.parseUnits(v, 6);
    const c = new ethers.Contract(CONF.SEPOLIA.oapp, ABIS.OFT, signer);
    const p = [CONF.SEPOLIA.eid, pad(account), amt, amt, CONF.SEPOLIA.lzOpt, "0x", "0x"];
    log("Quoting...");
    const f = await c.quoteSend(p, false);
    cachedFee = f[0];
    log(`Fee: ${ethers.formatEther(cachedFee).slice(0,6)} ETH`);
    getEl('btn-bridge').disabled = false;
  } catch(e) { log("Quote Failed"); }
}

async function runBridge() {
  if(!cachedFee) return alert("Quote First");
  try {
    const v = getEl('in-bridge').value;
    const amt = ethers.parseUnits(v, 6);
    const c = new ethers.Contract(CONF.SEPOLIA.oapp, ABIS.OFT, signer);
    const p = [CONF.SEPOLIA.eid, pad(account), amt, amt, CONF.SEPOLIA.lzOpt, "0x", "0x"];
    log("Bridging...");
    const tx = await c.send(p, [cachedFee, 0], account, {value: cachedFee});
    await tx.wait();
    log("Bridged! ✅ Check Stable soon.");
    updateBal();
  } catch(e) { log("Bridge Failed"); }
}

// 3. Unwrap
async function runApproveUnwrap() {
  try {
    const v = getEl('in-unwrap').value;
    const c = new ethers.Contract(CONF.STABLE.token, ABIS.ERC20, signer);
    log("Approving...");
    await (await c.approve(CONF.STABLE.wrapper, ethers.parseUnits(v, 6))).wait(); // 6 Decimals
    log("Approved ✅");
    getEl('btn-unwrap').disabled = false;
  } catch(e) { log(e.reason||e.message); }
}

async function runSwap() {
  try {
    const v = getEl('in-unwrap').value;
    const c = new ethers.Contract(CONF.STABLE.wrapper, ABIS.WRAPPER, signer);
    log("Unwrapping...");
    await (await c.withdraw(ethers.parseUnits(v, 6))).wait(); // 6 Decimals
    log("Success! You have gUSDT ✅");
    updateBal();
  } catch(e) { log(e.reason||e.message); }
}

</script>
</body>
</html>
